<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard • Folio Builder</title>

  <!-- Material Symbols (icons) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
  <style>
    /* ====== Minimal tokens (kept light so it plays nice with your styles.css) ====== */
    :root{
      --bg:#f4f6fb; --surface:#fff; --ink:#111319; --muted:#6b7280; --border:#e6e8ee;
      --brand:#0f62fe; --brand-ink:#fff; --radius:14px;
      --shadow:0 1px 2px rgba(17,19,25,0.05), 0 12px 30px rgba(17,19,25,0.06);
    }
    *{ box-sizing:border-box; } html,body{ margin:0; background:var(--bg); color:var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    a{ color:inherit; text-decoration:none; }

    /* ====== Topbar ====== */
    .topbar{ position:sticky; top:0; z-index:20; height:56px; background:var(--surface);
      border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; padding:0 12px; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:700; }
    .logo-img{ width:28px; height:28px; border-radius:6px; object-fit:cover; }
    .muted{ color:var(--muted); }
    .grow{ flex:1; }
    .search{ display:flex; align-items:center; gap:8px; padding:6px 10px; background:#fff;
      border:1px solid var(--border); border-radius:10px; max-width:540px; width:100%; }
    .search input{ border:0; outline:0; width:100%; font:inherit; }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid var(--border);
      border-radius:10px; background:#fff; cursor:pointer; font-weight:600; }
    .btn-primary{ background:var(--brand); color:var(--brand-ink); border-color:var(--brand); }
    .icon{ font-family: "Material Symbols Outlined"; font-size:20px; line-height:1; }
    .top-actions{ display:flex; gap:12px; align-items:center; }

    /* Icon buttons (Inbox/Notif/Account) */
    .icon-btn{
      position:relative; display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border-radius:999px; cursor:pointer; background:transparent; border:none;
    }
    .icon-btn:hover{ background:#f2f5ff; }
    .icon-btn .icon{ font-family:"Material Symbols Outlined"; font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24; font-size:22px; color:#374151; }
    .badge{
      position:absolute; top:-3px; right:-3px; min-width:18px; height:18px; padding:0 5px;
      border-radius:999px; background:#ef4444; color:#fff; font-size:11px; line-height:18px; font-weight:700; text-align:center; border:2px solid #fff;
    }

    /* Profile dropdown */
    .profile-dropdown{ position:absolute; top:56px; right:12px; width:280px; background:#fff; border:1px solid var(--border);
      border-radius:12px; box-shadow:var(--shadow); display:none; z-index:30; overflow:hidden; }
    .profile-dropdown.show{ display:block; }
    .profile-dropdown .menu-title{ font-weight:700; padding:10px 12px; border-bottom:1px solid var(--border); background:#fafbff; }
    .profile-dropdown .menu-item{ padding:10px 12px; border-bottom:1px solid var(--border); }
    .profile-dropdown .menu-item:last-child{ border-bottom:0; }

    /* ====== Layout ====== */
    .shell{ position:relative; }
    .sidebar{ position:fixed; top:56px; left:0; bottom:0; width:252px; background:#fff; border-right:1px solid var(--border); padding:12px; overflow:auto; z-index:10; }
    .sidebar.is-collapsed{ width:72px; }
    .sidebar .group-label{ font-size:.78rem; color:var(--muted); margin:10px 8px 6px; }
    .sidebar .item{ display:flex; align-items:center; gap:12px; padding:10px 10px; border-radius:10px; color:#2b2f37; }
    .sidebar .item:hover{ background:#f4f7ff; }
    .sidebar .item .text{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .nav-sep{ border-top:1px solid var(--border); margin:10px 8px; }

    .main{ margin:16px; margin-left: calc(252px + 16px); }
    .sidebar.is-collapsed ~ .main{ margin-left: calc(72px + 16px); }

    /* Panels that slide over content (Portfolio/Applications/Analytics) */
    .panel{
      position: fixed; top:72px; left:252px; min-width:300px; max-width:360px; background:#fff;
      border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:12px; z-index:30;
    }
    .sidebar.is-collapsed ~ .panel{ left:72px; }

    /* Cards */
    .card{ background:#fff; border:1px solid var(--border); border-radius:var(--radius); box-shadow: var(--shadow); }
    .pad{ padding:16px; }
    .title{ font-size:clamp(22px, 3.2vw, 32px); margin:0 0 4px; }

    /* Checklist */
    .checklist-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .progress{ display:flex; align-items:center; gap:8px; font-weight:600; }
    .meter{ height:8px; width:180px; background:#eef0f6; border-radius:999px; overflow:hidden; border:1px solid var(--border); }
    .meter > i{ display:block; height:100%; width:0%; background:var(--brand); }
    .tasks{ display:grid; gap:8px; }
    .task{ display:grid; grid-template-columns:28px 1fr auto; align-items:center; gap:8px; border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:#fff; }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; font-weight:600; }
    .chip.primary{ background:var(--brand); color:#fff; border-color:var(--brand); }

    @media (max-width:980px){
      .sidebar{ transform:translateX(-100%); transition:transform .2s ease; width:272px; }
      .sidebar.is-open{ transform:translateX(0); }
      .main{ margin-left:16px; }
      .search{ display:none; }
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <header class="topbar">
    <button class="btn" id="sidebarToggle"><span class="icon">menu</span>menu</button>

    <div class="brand">
      <!-- IMPORTANT: no nested anchors -->
      <a href="index.html" class="nav-left">
        <img src="assets/placeholder-icon.jpg" alt="Portfolio Logo" class="logo-img">
        <span>Folio Builder</span>
      </a>
      <span class="muted">|</span>
      <a class="muted" href="#">My Site</a>
    </div>

    <div class="grow"></div>

    <label class="search">
      <span class="icon">search</span>
      <input placeholder="Search for tools, apps, help & more…" />
    </label>

    <!-- CTA shown/hidden by session state (used on home too); safe to keep here -->
    <a class="btn" data-cta="signin" href="/login">Sign In</a>
    <a class="btn btn-primary" data-cta="getstarted" href="/register">Get started</a>

    <!-- Top-right icons (visible only when logged in) -->
    <div class="top-actions" id="topActions">
      <button class="icon-btn" aria-label="Inbox" data-panel="inboxPanel">
        <span class="icon">inbox</span><span class="badge" id="inboxBadge">3</span>
      </button>
      <button class="icon-btn" aria-label="Notifications" data-panel="notifPanel">
        <span class="icon">notifications</span><span class="badge" id="notifBadge">2</span>
      </button>
      <button class="icon-btn" aria-label="Account" id="profileIconBtn">
        <span class="icon">account_circle</span>
      </button>
    </div>

    <!-- Profile dropdown (reused on home + dashboard) -->
    <div class="profile-dropdown" id="profileDropdown" aria-hidden="true">
      <div class="menu-title">Account</div>
      <div class="menu-item"><strong id="profileName">—</strong><br><span id="profileEmail" class="muted">—</span></div>
      <div class="menu-item"><a href="/settings">Settings</a></div>
      <div class="menu-item"><button class="btn" id="logoutBtn">Log out</button></div>
    </div>
  </header>

  <div class="shell">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="group-label">Workspace</div>
      <a class="item" href="#setup"><span class="icon">tune</span><span class="text">Setup</span></a>
      <a class="item" href="#portfolio" data-panel="portfolioPanel"><span class="icon">work</span><span class="text">Portfolio</span></a>
      <a class="item" href="#applications" data-panel="applicationsPanel"><span class="icon">assignment_turned_in</span><span class="text">Job Applications</span></a>
      <a class="item" href="#analytics" data-panel="analyticsPanel"><span class="icon">insights</span><span class="text">Analytics</span></a>

      <div class="nav-sep"></div>

      <div class="group-label">Other</div>
      <a class="item" href="#inbox" data-panel="inboxPanel"><span class="icon">inbox</span><span class="text">Inbox</span></a>
      <a class="item" href="#settings"><span class="icon">settings</span><span class="text">Settings</span></a>
      <a class="item" href="#help"><span class="icon">help</span><span class="text">Help</span></a>
      <div style="height:8px"></div>
    </aside>

    <!-- Panels (one instance each; toggle by data-panel) -->
    <div class="panel" id="portfolioPanel" hidden>
      <h3 style="margin:6px 0 10px">Portfolio</h3>
      <div>
        <button class="btn btn-primary" data-route="create-portfolio">Create Portfolio</button>
      </div>
      <hr>
      <div id="portfolioList" class="muted">No portfolios yet.</div>
    </div>

    <div class="panel" id="applicationsPanel" hidden>
      <h3 style="margin:6px 0 10px">Job Applications</h3>
      <div class="muted">Track applications, statuses, interviews, notes.</div>
    </div>

    <div class="panel" id="analyticsPanel" hidden>
      <h3 style="margin:6px 0 10px">Analytics</h3>
      <div class="muted">Views, referrers, clicks (premium later).</div>
    </div>

    <div class="panel" id="inboxPanel" hidden>
      <h3 style="margin:6px 0 10px">Inbox</h3>
      <div class="muted">Messages & notifications.</div>
    </div>

    <!-- Main content -->
    <main class="main" id="main">
      <section class="card pad">
        <h1 class="title">Welcome to your Dashboard</h1>
        <p class="muted">Let’s set up your business</p>
        <div style="height:12px"></div>

        <div class="checklist-head">
          <div class="muted"><span id="countLabel">0/4 completed</span></div>
          <div class="progress"><div class="meter"><i id="meterBar" style="width:0%"></i></div></div>
        </div>

        <div class="tasks" id="tasks"></div>
      </section>
    </main>
  </div>

  <script>
    /* ====================== Helpers ====================== */
    const $  = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const safeJSON = async (res) => { try { return await res.json(); } catch { return null; } };
    const fetchJSON = async (url, opts={}) => { const r = await fetch(url, opts); if(!r.ok) throw new Error(r.statusText); return safeJSON(r); };

    /* ====================== Sidebar toggle ====================== */
    const sidebar = $('#sidebar');
    $('#sidebarToggle')?.addEventListener('click', () => {
      if (window.matchMedia('(max-width: 980px)').matches){
        sidebar.classList.toggle('is-open');
      } else {
        sidebar.classList.toggle('is-collapsed');
      }
    });

    /* ====================== Panels: open/close ====================== */
    document.addEventListener('click', (e) => {
      const link = e.target.closest('[data-panel]');
      if (link){
        e.preventDefault();
        const id = link.getAttribute('data-panel');
        $$('.panel').forEach(p => p.hidden = true);
        const panel = document.getElementById(id);
        if (panel) panel.hidden = false;
      } else {
        // click-away close (except if clicking inside any .panel)
        const insidePanel = e.target.closest('.panel') || e.target.closest('[data-panel]');
        if (!insidePanel) $$('.panel').forEach(p => p.hidden = true);
      }
    });

    /* ====================== Profile dropdown ====================== */
    const profileBtn = $('#profileIconBtn');
    const profileDrop = $('#profileDropdown');
    profileBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      profileDrop.classList.toggle('show');
    });
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#profileDropdown') && !e.target.closest('#profileIconBtn')){
        profileDrop?.classList.remove('show');
      }
    });

    /* ====================== Session-aware UI ====================== */
    function applySessionUI(isLoggedIn){
      const signIn    = document.querySelector('[data-cta="signin"]');
      const getStart  = document.querySelector('[data-cta="getstarted"]');
      const topActs   = document.getElementById('topActions');
      if (isLoggedIn){
        if (signIn)   signIn.style.display = 'none';
        if (getStart){ getStart.textContent = 'Go to Dashboard'; getStart.setAttribute('href','/dashboard.html'); }
        if (topActs)  topActs.style.display = '';   // show icons
      } else {
        if (signIn)   signIn.style.display = '';
        if (getStart){ getStart.textContent = 'Get started'; getStart.setAttribute('href','/register'); }
        if (topActs)  topActs.style.display = 'none'; // hide icons
      }
    }

    /* ====================== Server-backed checklist ====================== */
    let userChecklist = {};    // single source of truth

    function renderChecklist(){
      const tasksEl  = $('#tasks');
      const countLbl = $('#countLabel');
      const meterBar = $('#meterBar');

      const steps = [
        { id:'site-type', label:'Update your site type', cta:'Open' },
        { id:'domain',    label:'Connect a custom domain', cta:'Let’s Go' },
        { id:'project',   label:'Add a project to your portfolio', cta:'Add Project' },
        { id:'design-site', label:'Design your website', cta:'Design Site' },
      ];

      tasksEl.innerHTML = '';
      let complete = 0;

      steps.forEach(step => {
        const checked = !!userChecklist[step.id];
        if (checked) complete++;

        const row = document.createElement('div');
        row.className = 'task';
        row.innerHTML = `
          <label><input type="checkbox" ${checked ? 'checked' : ''} data-id="${step.id}" /></label>
          <div>
            <div style="font-weight:700">${step.label}</div>
          </div>
          <div class="action">
            ${step.cta ? `<button class="chip primary">${step.cta}</button>` : ''}
          </div>
        `;
        tasksEl.appendChild(row);
      });

      const pct = Math.round((complete / steps.length) * 100);
      meterBar.style.width = pct + '%';
      countLbl.textContent = `${complete}/${steps.length} completed`;
    }

    async function saveChecklist(){
      try{
        await fetch('/saveChecklist', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(userChecklist)
        });
      }catch(e){ console.warn('saveChecklist failed:', e); }
    }

    document.addEventListener('change', (e) => {
      if (e.target.matches('#tasks input[type="checkbox"]')){
        const id = e.target.getAttribute('data-id');
        userChecklist[id] = e.target.checked;
        renderChecklist();
        saveChecklist();
      }
    });

    /* ====================== Logout (and ensure router is NOT inside) ====================== */
    document.getElementById("logoutBtn")?.addEventListener("click", async () => {
      try{
        // If you have a backend endpoint, uncomment:
        // await fetch('/logout', { method:'POST' });
      } finally {
        localStorage.removeItem('sessionUser');
        location.href = '/index.html';
      }
    });

    /* ====================== Simple “My Portfolios” view switcher ====================== */
    const routes = {
      'create-portfolio': () => {
        const list = $('#portfolioList');
        list.innerHTML = `
          <div style="margin-bottom:8px"><strong>Create a new portfolio</strong></div>
          <div class="muted">Templates (coming soon)</div>
          <div style="display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:10px; margin-top:8px;">
            <div style="height:80px; border:1px dashed var(--border); border-radius:12px;"></div>
            <div style="height:80px; border:1px dashed var(--border); border-radius:12px;"></div>
            <div style="height:80px; border:1px dashed var(--border); border-radius:12px;"></div>
          </div>
          <div style="margin-top:12px;">
            <button class="btn btn-primary">Create</button>
          </div>
        `;
      }
    };

    document.addEventListener('click', (e) => {
      const link = e.target.closest('[data-route]');
      if (!link) return;
      e.preventDefault();
      const r = link.getAttribute('data-route');
      routes[r]?.();
    });

    /* ====================== Init ====================== */
    async function init(){
      // Load user info (classmate’s behavior)
      try{
        const user = await fetchJSON('/getUserInfo');
        if (user){
          const name = user.name || '—';
          const email = user.email || '—';
          $('#profileName').textContent = name;
          $('#profileEmail').textContent = email;
          localStorage.setItem('sessionUser', email || '1'); // basic client flag
          applySessionUI(true);
        }else{
          applySessionUI(false);
        }
      }catch{
        applySessionUI(false);
      }

      // Load checklist (classmate’s behavior)
      try{
        const data = await fetchJSON('/getChecklist');
        userChecklist = data || {};
      }catch{
        userChecklist = {};
      }
      renderChecklist();
    }

    init();
  </script>
</body>
</html>
